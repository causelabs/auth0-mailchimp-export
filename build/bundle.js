module.exports=function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var n=r(16);e.exports=n.fromExpress(r(2))},function(e,t){e.exports=require("q")},function(e,t,r){function n(e,t){var r=e.webtaskContext,n=["AUTH0_DOMAIN","AUTH0_CLIENT_ID","AUTH0_CLIENT_SECRET","MAILCHIMP_API_KEY","MAILCHIMP_LIST_NAME"],i=n.filter(function(e){return!r.data[e]});if(i.length)return t.status(400).send({message:"Missing settings: "+i.join(", ")});var s={TENANT_DOMAIN:e.webtaskContext.data.AUTH0_DOMAIN,USER_SEARCH_MGMT_TOKEN:e.access_token,MAILCHIMP_API_KEY:r.data.MAILCHIMP_API_KEY,MAILCHIMP_LIST_NAME:r.data.MAILCHIMP_LIST_NAME,UPDATE_DAYS:r.data.UPDATE_DAYS};console.log("AME: Begin synchronization"),o(s,function(e){return e?t.sendStatus(500).send("Error - please see logs for details"):(console.log("AME: Synchronization complete"),t.status(200).send("All done!"))})}function o(e,t){c(e).then(function(){return t()},function(e){return t(e)})}var i=r(9),s=i(),a=r(10),u=r(15),c=r(7),l=r(3),h=a({load:function(e,t,r,n,o){u.post(e).send({audience:t,grant_type:"client_credentials",client_id:r,client_secret:n}).type("application/json").end(function(e,t){e||!t.ok?o(null,e):o(t.body.access_token)})},hash:function(e){return e},max:100,maxAge:36e5});s.use(function(e,t,r){if("/meta"===e.path)return r();var n="https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/oauth/token",o="https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/api/v2/",i=e.webtaskContext.data.AUTH0_CLIENT_ID,s=e.webtaskContext.data.AUTH0_CLIENT_SECRET;h(n,o,i,s,function(t,n){return n?(console.error("Error getting access_token",n),r(n)):(e.access_token=t,void r())})}),s.get("/",n),s.post("/",n),s.get("/meta",function(e,t){t.status(200).send(l)}),e.exports=s},function(e,t){e.exports={codeUrl:"https://github.com/causelabs/auth0-mailchimp-export",title:"Auth0 MailChimp Export",name:"auth0-mailchimp-export",version:"1.0.1",author:"Auth0 / CauseLabs",description:"Allows Auth0 accounts to synchronize their Auth0 user base (e.g., those that have an email address and are verified) with a MailChimp list",type:"cron",repository:"https://github.com/causelabs/auth0-mailchimp-export",keywords:["auth0","mailchimp","user profile"],schedule:"0 */5 * * * *",secrets:{AUTH0_DOMAIN:{description:"The Auth0 domain to authorize.",required:!0},AUTH0_CLIENT_ID:{description:"The Auth0 client ID to authorize.",required:!0},AUTH0_CLIENT_SECRET:{description:"The Auth0 client secret associated with the client ID above.",required:!0},MAILCHIMP_API_KEY:{description:"The MailChimp API key associated with your MailChimp user account, e.g. f1b0602xy124d85d8444a5d4e5eed-us14",required:!0},MAILCHIMP_LIST_NAME:{description:"The name of the MailChimp list to which you wish to export Auth0 user profiles, e.g. Auth0-DBConn1",required:!0},UPDATE_DAYS:{description:"The number of days back from job instantiation date to retrieve users (default: 1). Use * for all records, but this will timeout on Auth0.",required:!0,default:1}}}},function(e,t,r){"use strict";var n=r(14),o=r(13),i=r(1),s=r(12),a=function(e,t,r,u){var c=e.TENANT_DOMAIN,l=e.USER_SEARCH_MGMT_TOKEN,h="*"!==e.UPDATE_DAYS?s().subtract(e.UPDATE_DAYS,"days").format("YYYY-MM-DD"):"*",p=i.defer(),d="email_verified:true AND _exists_:email AND updated_at:["+h+" TO *]",A={q:d,search_engine:"v2",per_page:r,page:u,sort:"updated_at:-1",fields:"email,given_name,family_name",include_fields:"true"},m={method:"GET",url:"https://"+c+"/api/v2/users",qs:A,headers:{"cache-control":"no-cache",authorization:"Bearer "+l}};return n(m,function(n,i,s){if(n)return p.reject(new Error(n));var c=JSON.parse(s);return c.length>0?(t=o.concat(t,c),console.log('AME: Executing query: "'+d+'"; retrieved '+t.length+" users"),p.resolve(a(e,t,r,u+1))):(console.log("AME: User retrieval complete"),p.resolve(t))}),p.promise},u=function(e){return function(t){console.log("AME: Attempting to retrieve Auth0 users"),a(e,[],100,0).then(function(e){var r=e.length;return console.log("AME: Total number of Auth0 users: "+r),t(null,e)},function(e){console.error("ERROR: "+e),t(e)})}};e.exports=u},function(e,t){"use strict";var r=function(e,t){var r=e.MAILCHIMP_LIST_NAME;return function(e,n){t.lists_list({filters:{list_name:r}},function(t,r){if(t)return console.error(t),n(t);var o=r.data[0],i=o.id,s=o.name;return console.log("AME: MailChimp list ID/name: "+i+" / "+s),n(null,{mailChimpList:o,auth0Users:e})})}};e.exports=r},function(e,t){"use strict";var r=function(e,t){return function(e,r){var n=e.mailChimpList.id,o=e.auth0Users;console.log("AME: "+o.length+" users retrieved from Auth0");var i=o.filter(function(e){return!e.email.includes("+")}).map(function(e){return{email:{email:e.email},email_type:"text",merge_vars:{FNAME:e.given_name||"",LNAME:e.family_name||""}}});console.log("AME: "+i.length+" valid email address users to synchronize with Mailchimp");var s={id:n,batch:[],double_optin:!1,update_existing:!0,replace_interests:!0},a=2e3,u=i.length,c=0,l=1,h=parseInt(i.length/a,10)+1;console.log("AME: Beginning Mailchimp synchronization ("+h+" total calls required)");var p=function(n){s.batch=i.splice(n,a),console.log("AME: Synchronizing with Mailchimp, please wait ("+l+"/"+h+") ..."),t.lists_batch_subscribe(s,function(t,n){return t?(console.error("AME: "+t),r(t)):(c+=a,console.log("AME: Mailchimp batch list update completed successfully; processed "+(c<u?c:u)+"/"+u+" records"),n.error_count>0&&console.log("AME: "+n.error_count+" error(s) encountered from Mailchimp:"+JSON.stringify(n.errors)),l++,c<u?void p(c):r(null,e))})};p(0)}};e.exports=r},function(e,t,r){"use strict";var n=r(11).MailChimpAPI,o=r(8),i=r(1),s=function(e){var t=e.MAILCHIMP_API_KEY;try{console.log("AME: Attempting to connect to MailChimp API");var s=new n(t,{version:"2.0"})}catch(e){return console.log(e.message)}console.log("AME: Mailchimp API created");var a=r(4)(e),u=r(5)(e,s),c=r(6)(e,s),l=i.defer();return console.log("AME: Preparing user retrieval"),o.waterfall([a,u,c],function(e){return e?(console.error(e),l.reject(new Error(e))):l.resolve()}),l.promise};e.exports=s},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("lru-memoizer")},function(e,t){e.exports=require("mailchimp")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("superagent")},function(e,t){e.exports=require("webtask-tools")}]);
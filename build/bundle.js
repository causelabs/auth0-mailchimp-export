module.exports=function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){var n=r(15);e.exports=n.fromExpress(r(2))},function(e,t){e.exports=require("q")},function(e,t,r){function n(e,t){var r=e.webtaskContext,n=["AUTH0_DOMAIN","AUTH0_CLIENT_ID","AUTH0_CLIENT_SECRET","MAILCHIMP_API_KEY","MAILCHIMP_LIST_NAME"],i=n.filter(function(e){return!r.data[e]});if(i.length)return t.status(400).send({message:"Missing settings: "+i.join(", ")});var s={TENANT_DOMAIN:e.webtaskContext.data.AUTH0_DOMAIN,USER_SEARCH_MGMT_TOKEN:e.access_token,MAILCHIMP_API_KEY:r.data.MAILCHIMP_API_KEY,MAILCHIMP_LIST_NAME:r.data.MAILCHIMP_LIST_NAME};console.log("--- Begin synchronization"),o(s,function(e){return e?t.sendStatus(500).send("Error - please see logs for details"):t.status(200).send("All done!")})}function o(e,t){c(e).then(function(){return t()},function(e){return t(e)})}var i=r(9),s=i(),a=r(10),u=r(14),c=r(7),l=r(3),h=a({load:function(e,t,r,n,o){u.post(e).send({audience:t,grant_type:"client_credentials",client_id:r,client_secret:n}).type("application/json").end(function(e,t){e||!t.ok?o(null,e):o(t.body.access_token)})},hash:function(e){return e},max:100,maxAge:36e5});s.use(function(e,t,r){if("/meta"===e.path)return r();var n="https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/oauth/token",o="https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/api/v2/",i=e.webtaskContext.data.AUTH0_CLIENT_ID,s=e.webtaskContext.data.AUTH0_CLIENT_SECRET;h(n,o,i,s,function(t,n){return n?(console.error("Error getting access_token",n),r(n)):(e.access_token=t,void r())})}),s.get("/",n),s.post("/",n),s.get("/meta",function(e,t){t.status(200).send(l)}),e.exports=s},function(e,t){e.exports={codeUrl:"https://github.com/causelabs/auth0-mailchimp-export",title:"Auth0 MailChimp Export",name:"auth0-mailchimp-export",version:"1.0.0",author:"auth0 / CauseLabs",description:"Allows Auth0 accounts to synchronize their Auth0 user base (e.g., those that have an email address and are verified) with a MailChimp list",type:"cron",repository:"https://github.com/causelabs/auth0-mailchimp-export",keywords:["auth0","mailchimp","user profile"],schedule:"0 */5 * * * *",secrets:{AUTH0_DOMAIN:{description:"The Auth0 domain to authorize.",required:!0},AUTH0_CLIENT_ID:{description:"The Auth0 client ID to authorize.",required:!0},AUTH0_CLIENT_SECRET:{description:"The Auth0 client secret associated with the client ID above.",required:!0},MAILCHIMP_API_KEY:{description:"The MailChimp API key associated with your MailChimp user account, e.g. f1b0602xy124d85d8444a5d4e5eed-us14",required:!0},MAILCHIMP_LIST_NAME:{description:"The name of the MailChimp list to which you wish to export Auth0 user profiles, e.g. Auth0-DBConn1",required:!0}}}},function(e,t,r){"use strict";var n=r(13),o=r(12),i=r(1),s=function(e,t,r,a){console.log("--- - Attempting to retrieve Auth0 users");var u=e.TENANT_DOMAIN,c=e.USER_SEARCH_MGMT_TOKEN,l=i.defer(),h={q:"email_verified:true AND _exists_:email",search_engine:"v2",per_page:r,page:a,sort:"email:1",fields:"email,given_name,family_name",include_fields:"true"},p={method:"GET",url:"https://"+u+"/api/v2/users",qs:h,headers:{"cache-control":"no-cache",authorization:"Bearer "+c}};return n(p,function(n,i,u){if(n)return l.reject(new Error(n));var c=JSON.parse(u);return c.length>0?(t=o.concat(t,c),console.log("--- -- "+t.length+" users retrieved"),l.resolve(s(e,t,r,a+1))):(console.log("--- -- All users retrieved"),l.resolve(t))}),l.promise},a=function(e){return function(t){s(e,[],20,0).then(function(e){var r=e.length;return console.log("Total number of Auth0 users: "+r),t(null,e)},function(e){console.error("ERROR: "+e),t(e)})}};e.exports=a},function(e,t){"use strict";var r=function(e,t){var r=e.MAILCHIMP_LIST_NAME;return function(e,n){t.lists_list({filters:{list_name:r}},function(t,r){if(t)return console.error(t),n(t);var o=r.data[0],i=o.id,s=o.name;return console.log("MailChimp list ID/name: "+i+" / "+s),n(null,{mailChimpList:o,auth0Users:e})})}};e.exports=r},function(e,t){"use strict";var r=function(e,t){return function(e,r){var n=e.mailChimpList.id,o=e.auth0Users,i={id:n,batch:o.filter(function(e){return!e.email.includes("+")}).map(function(e){return{email:{email:e.email},email_type:"text",merge_vars:{FNAME:e.given_name||"",LNAME:e.family_name||""}}}),double_optin:!1,update_existing:!0,replace_interests:!0};console.log(o.length+" users retrieved from Auth0"),console.log(i.batch.length+" valid email address users to synchronize with Mailchimp"),t.lists_batch_subscribe(i,function(t,n){return t?(console.error(t),r(t)):(console.log("Mailchimp batch list update completed successfully"),n.error_count>0&&(console.log(n.error_count+" error(s) encountered from Mailchimp:"),console.log(n.errors)),r(null,e))})}};e.exports=r},function(e,t,r){"use strict";var n=r(11).MailChimpAPI,o=r(8),i=r(1),s=function(e){var t=e.MAILCHIMP_API_KEY;try{console.log("--- - Attempting to connect to Mailchimp API...");var s=new n(t,{version:"2.0"})}catch(e){return console.log(e.message)}console.log("--- - Mailchimp API created");var a=r(4)(e),u=r(5)(e,s),c=r(6)(e,s),l=i.defer();return console.log("--- - Preparing user retrieval"),o.waterfall([a,u,c],function(e){return e?(console.error(e),l.reject(new Error(e))):l.resolve()}),l.promise};e.exports=s},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("lru-memoizer")},function(e,t){e.exports=require("mailchimp")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("superagent")},function(e,t){e.exports=require("webtask-tools")}]);